<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - ADM Alligator Agent</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.4.1/css/responsive.dataTables.min.css">
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
    #admin-container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h1 { color: #5E8C6A; }
    table.dataTable thead th, table.dataTable thead td { background-color: #E8F5E9; border-bottom: 2px solid #A8C09F; }
    table.dataTable tfoot th, table.dataTable tfoot td { background-color: #E8F5E9; border-top: 2px solid #A8C09F; }
    .dt-button, button#exportCsvBtn {
      background-color: #5E8C6A; color: white; border: none; padding: 10px 15px;
      border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-bottom: 10px;
    }
    .dt-button:hover, button#exportCsvBtn:hover { background-color: #4A7055; }
    #exportCsvBtn { margin-left: 10px; }
    
    /* Improved text handling */
    .truncate-text {
      max-width: 250px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    
    /* Modal styles for showing full text */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      border-radius: 8px;
      max-height: 70vh;
      overflow-y: auto;
    }
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-modal:hover { color: black; }
    
    /* Better spacing for quality scores */
    .quality-score {
      text-align: center;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 3px;
      display: inline-block;
      min-width: 20px;
    }
    .quality-low { background-color: #ffcdd2; color: #c62828; }
    .quality-med { background-color: #fff9c4; color: #f57f17; }
    .quality-high { background-color: #c8e6c9; color: #2e7d32; }
    
    /* Add style for full text cells */
    .full-text-cell {
      cursor: pointer;
      white-space: normal; /* Allow text to wrap */
      word-break: break-word; /* Break long words if needed */
    }
    .full-text-cell:hover {
      background-color: #f5f5f5; /* Light gray background on hover */
    }
    /* Make sure the table cells can expand */
    table.dataTable td {
      white-space: normal;
      word-break: break-word;
    }
    
    /* Style for the responsive child rows */
    .child tr td:first-child {
      width: 150px;
      font-weight: bold;
      vertical-align: top;
      padding-right: 10px;
    }
    
    .child tr td:last-child {
      white-space: normal;
      word-break: break-word;
    }
    
    /* Make the child rows better spaced */
    .child table {
      width: 100%;
    }
    
    .child tr {
      border-bottom: 1px solid #eee;
    }
    
    .child tr:last-child {
      border-bottom: none;
    }
    
    /* Add styles for height-restricted cells with ellipsis */
    .height-restricted {
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 4; /* Restrict to 4 lines */
      -webkit-box-orient: vertical;
      cursor: pointer;
      position: relative;
    }
    
    .height-restricted::after {
      content: "...";
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: white;
      padding: 0 4px;
    }
    
    /* Update modal styles to show related quality score */
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .modal-quality {
      margin-left: 15px;
    }
  </style>
</head>
<body>

<div id="admin-container">
  <h1>Project Ideas - Admin Dashboard</h1>
  <button id="exportCsvBtn">Export to CSV</button>
  <table id="ideasTable" class="display responsive nowrap" style="width:100%">
    <thead>
      <tr>
        <th>ID</th>
        <th>Clock ID</th>
        <th>Date</th>
        <th>Summary</th>
        <th>Task to Improve</th>
        <th>Q</th>
        <th>Current Process</th>
        <th>Q</th>
        <th>Time/Effort</th>
        <th>Q</th>
        <th>Benefiting Team</th>
        <th>Q</th>
        <th>Success Measurement</th>
        <th>Q</th>
        <th>Data Sources</th>
        <th>Q</th>
        <th>Unintended Outcomes</th>
        <th>Q</th>
        <th>AI Candidacy</th>
        <th>Q</th>
        <th>Session ID</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
  </table>
</div>

<!-- Modal for displaying full text -->
<div id="textModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <div class="modal-header">
      <h3 id="modal-title">Full Text</h3>
      <div id="modal-quality"></div>
    </div>
    <p id="modal-text"></p>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.4.1/js/dataTables.responsive.min.js"></script>
<script>
$(document).ready(function() {
  // Setup modal functionality
  const modal = document.getElementById("textModal");
  const modalTitle = document.getElementById("modal-title");
  const modalText = document.getElementById("modal-text");
  const modalQuality = document.getElementById("modal-quality");
  const closeModal = document.getElementsByClassName("close-modal")[0];
  
  closeModal.onclick = function() {
    modal.style.display = "none";
  }
  
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
  
  // Function to show full text in modal
  function showFullText(title, text, quality) {
    modalTitle.textContent = title;
    modalText.textContent = text;
    
    // Set the quality score if available
    if (quality !== undefined) {
      let className = "quality-med";
      if (quality >= 4) className = "quality-high";
      if (quality <= 2) className = "quality-low";
      modalQuality.innerHTML = `<span class="quality-score ${className}">${quality}</span>`;
      modalQuality.style.display = "block";
    } else {
      modalQuality.style.display = "none";
    }
    
    modal.style.display = "block";
  }
  
  // Function to format quality scores
  function formatQuality(quality) {
    if (!quality) return "<span>N/A</span>";
    
    let className = "quality-med";
    if (quality >= 4) className = "quality-high";
    if (quality <= 2) className = "quality-low";
    
    return `<span class="quality-score ${className}">${quality}</span>`;
  }
  
  // Text renderer for height-restricted text with click capability
  function renderHeightRestrictedText(data, type, row, meta) {
    if (type === 'display' && data) {
      return `<div class="height-restricted full-text-cell" title="Click to view in popup">${data}</div>`;
    }
    return data;
  }

  const columns = [
    { data: 'id', title: 'ID', width: "40px" },
    { data: 'clockId', title: 'Clock ID', width: "70px" },
    { 
      data: 'createdAt',
      title: 'Date',
      width: "100px",
      render: function(data) {
        if (!data) return 'N/A';
        const date = new Date(data.replace(' ', 'T'));
        return date.toLocaleDateString();
      }
    },
    { 
      data: 'summary', 
      title: 'Summary',
      render: renderHeightRestrictedText
    },
    { 
      data: 'taskToImprove_text', 
      title: 'Task to Improve',
      render: renderHeightRestrictedText
    },
    { 
      data: 'taskToImprove_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'currentProcess_text', 
      title: 'Current Process',
      render: renderHeightRestrictedText
    },
    { 
      data: 'currentProcess_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'timeEffort_text', 
      title: 'Time/Effort',
      render: renderHeightRestrictedText
    },
    { 
      data: 'timeEffort_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'benefitingTeam_text', 
      title: 'Benefiting Team',
      render: renderHeightRestrictedText
    },
    { 
      data: 'benefitingTeam_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'successMeasurement_text', 
      title: 'Success Measurement',
      render: renderHeightRestrictedText
    },
    { 
      data: 'successMeasurement_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'dataSources_text', 
      title: 'Data Sources',
      render: renderHeightRestrictedText
    },
    { 
      data: 'dataSources_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'unintendedOutcomes_text', 
      title: 'Unintended Outcomes',
      render: renderHeightRestrictedText
    },
    { 
      data: 'unintendedOutcomes_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'aiCandidacy_text', 
      title: 'AI Candidacy',
      render: renderHeightRestrictedText
    },
    { 
      data: 'aiCandidacy_quality', 
      title: 'Q',
      width: "30px",
      render: formatQuality,
      className: 'dt-center'
    },
    { 
      data: 'sessionId', 
      title: 'Session ID',
      visible: false // Hide by default as it's not usually needed
    }
  ];

  const table = $('#ideasTable').DataTable({
    ajax: {
      url: '/admin/data',
      dataSrc: ''
    },
    columns: columns,
    pageLength: 10,
    lengthMenu: [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
    responsive: {
      details: {
        display: $.fn.dataTable.Responsive.display.childRowImmediate,
        type: 'none',
        renderer: function(api, rowIdx, columns) {
          const data = $.map(columns, function(col, i) {
            // Only render hidden columns with content
            if (!col.hidden || !col.data) return '';
            
            // Format for quality scores
            let content = col.data;
            if (col.title === 'Q' && content) {
              let className = "quality-med";
              if (content >= 4) className = "quality-high";
              if (content <= 2) className = "quality-low";
              content = `<span class="quality-score ${className}">${content}</span>`;
            }
            
            return `<tr>
                      <td><strong>${col.title}:</strong></td>
                      <td>${content}</td>
                    </tr>`;
          }).join('');
          
          return data ? 
            $('<table/>').append(data) : 
            false;
        }
      }
    },
    order: [[0, 'desc']], // Sort by ID descending by default (newest first)
    columnDefs: [
      { responsivePriority: 1, targets: [0, 1, 2, 3] }, // These columns show first in responsive view
      { responsivePriority: 2, targets: [4, 6, 8, 10, 12, 14, 16, 18] } // Text content columns next priority
    ]
  });

  // Add click event for text cells to show modal with quality
  $('#ideasTable tbody').on('click', '.full-text-cell', function() {
    const cellIndex = table.cell($(this).closest('td')).index();
    const columnIndex = cellIndex.column;
    const rowIndex = cellIndex.row;
    const columnName = columns[columnIndex].title;
    const text = $(this).text();
    
    // Find the associated quality score if it exists
    let quality = undefined;
    if (columnName !== 'Summary') { // The only text field without a quality score
      // Determine which quality column corresponds to this text
      const qualityColIndex = columnIndex + 1; // Quality column is right after text column
      
      // Only proceed if the next column is actually a quality column
      if (qualityColIndex < columns.length && columns[qualityColIndex].title === 'Q') {
        quality = table.cell(rowIndex, qualityColIndex).data();
      }
    }
    
    showFullText(columnName, text, quality);
  });

  // CSV Export Functionality
  $('#exportCsvBtn').on('click', function() {
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Header row
    const header = columns.map(col => col.title);
    csvContent += header.join(",") + "\r\n";

    // Data rows (from current table view - respects filtering)
    table.rows({ search: 'applied' }).data().each(function(row) {
      let rowArray = [];
      columns.forEach(function(col) {
        let cellData = row[col.data] !== null && row[col.data] !== undefined ? row[col.data] : '';
        // Escape quotes and handle commas within data
        if (typeof cellData === 'string') {
          cellData = cellData.replace(/"/g, '""'); // Escape double quotes
          if (cellData.includes(',')) {
            cellData = `"${cellData}"`; // Enclose in quotes if contains comma
          }
        }
        rowArray.push(cellData);
      });
      csvContent += rowArray.join(",") + "\r\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "project_ideas_export.csv");
    document.body.appendChild(link); 
    link.click();
    document.body.removeChild(link);
  });
});
</script>
</body>
</html> 